<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Assistant V2.0</title>
    <style>
        /* Hide ALL Branding */
        [data-testid*="branding"],
        [data-testid*="powered"],
        [class*="branding"],
        [class*="powered"],
        [class*="elevenlabs"],
        [aria-label*="ElevenLabs"],
        [aria-label*="Powered by"],
        [title*="ElevenLabs"],
        [title*="Powered by"],
        a[href*="elevenlabs"],
        a[href*="conversational-ai"],
        .elevenlabs-branding,
        .powered-by-elevenlabs,
        .branding-text,
        .footer-branding,
        .widget-branding,
        .convai-branding,
        [data-branding],
        [data-powered-by],
        [data-elevenlabs],
        elevenlabs-convai::part(branding),
        elevenlabs-convai::part(footer),
        elevenlabs-convai::part(powered-by),
        elevenlabs-convai footer,
        elevenlabs-convai .footer,
        elevenlabs-convai [class*="footer"],
        elevenlabs-convai > div:last-child,
        elevenlabs-convai [class*="bottom"],
        elevenlabs-convai [class*="attribution"],
        elevenlabs-convai iframe[src*="elevenlabs"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            overflow: hidden !important;
        }

        elevenlabs-convai *[style*="font-size: 12px"],
        elevenlabs-convai *[style*="font-size: 10px"],
        elevenlabs-convai *[style*="font-size: 11px"] {
            display: none !important;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #666;
            font-size: 16px;
            color: white;
        }

        .error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }
        
        /* Chat toggle button styles */
        #ai-chat-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            font-size: 24px;
            user-select: none;
            border: none;
            outline: none;
        }
        
        #ai-chat-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
        }
        
        #ai-chat-toggle-btn:active {
            transform: scale(0.95);
        }
        
        #ai-widget-container-v2 {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            transition: all 0.3s ease;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            #ai-chat-toggle-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 15px;
                right: 15px;
            }
            
            #ai-widget-container-v2 {
                bottom: 15px;
                right: 15px;
            }
        }
        
        /* Status indicator */
        .status-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        
        /* Pulse animation for chat button */
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            }
            50% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.6), 0 0 0 10px rgba(102, 126, 234, 0.1);
            }
            100% {
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            }
        }
        
        #ai-chat-toggle-btn.pulse {
            animation: pulse 2s infinite;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        Loading AI Assistant V2.0...
    </div>
    
    <!-- Status Indicator -->
    <div class="status-indicator" id="status">
        Status: Initializing...
    </div>
    
    <!-- Chat Toggle Button -->
    <button id="ai-chat-toggle-btn" aria-label="Toggle AI Chat">
        ðŸ’¬
    </button>
    
    <!-- Widget Container -->
    <div id="ai-widget-container-v2"></div>
    
    <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

    <script>
        // State management
        let currentState = 'loading';
        let isInFrame = window.parent !== window;
        let elevenLabsWidget = null;
        let chatToggleButton = null;
        let widgetContainer = null;
        let isWidgetHidden = false;
        let isMobile = false;
        let hideTimer = null;
        let statusEl = document.getElementById('status');
        let loadingEl = document.getElementById('loading');
        
        // Update status
        function updateStatus(message) {
            if (statusEl) {
                statusEl.textContent = `Status: ${message}`;
            }
            console.log(`AI Widget V2.0: ${message}`);
        }
        
        // Send state to parent window
        function sendStateToParent(state) {
            if (isInFrame) {
                window.parent.postMessage({
                    type: 'widget-state-v2',
                    state: state,
                    isMobile: isMobile,
                    isHidden: isWidgetHidden
                }, '*');
            }
        }
        
        // Check if device is mobile
        function checkMobile() {
            isMobile = window.innerWidth <= 768;
            return isMobile;
        }
        
        // Get agent ID from URL parameter
        function getAgentId() {
            const urlParams = new URLSearchParams(window.location.search);
            const agentId = urlParams.get('agent');
            
            if (!agentId) {
                showError('No agent ID provided. Please add ?agent=YOUR_AGENT_ID to the URL.');
                return null;
            }
            
            return agentId;
        }

        function showError(message) {
            loadingEl.innerHTML = `
                <div class="error">
                    <h3>Configuration Error</h3>
                    <p>${message}</p>
                    <small>Example: ?agent=agent_01jxjyk81cfqrs9zer2vsp4h7e</small>
                </div>
            `;
            updateStatus('Error - Invalid configuration');
        }

        // Initialize widget with dynamic agent ID
        function initializeWidget() {
            const agentId = getAgentId();
            if (!agentId) return;
            
            updateStatus('Creating widget...');
            
            // Get elements
            chatToggleButton = document.getElementById('ai-chat-toggle-btn');
            widgetContainer = document.getElementById('ai-widget-container-v2');
            
            // Create widget element
            elevenLabsWidget = document.createElement('elevenlabs-convai');
            elevenLabsWidget.setAttribute('agent-id', agentId);
            
            // Add to container
            widgetContainer.appendChild(elevenLabsWidget);
            
            // Hide loading
            loadingEl.style.display = 'none';
            
            // Setup functionality
            setupWidgetFunctionality();
            
            // Start branding cleanup
            setTimeout(hideBranding, 500);
            setTimeout(hideBranding, 1000);
            setTimeout(hideBranding, 2000);
            setTimeout(hideBranding, 3000);
            setTimeout(hideBranding, 5000);
            
            // Monitor and remove branding continuously
            setInterval(hideBranding, 2000);
            
            // Show widget initially
            showWidget();
            
            // Auto-hide on mobile after 5 seconds
            if (checkMobile()) {
                setTimeout(() => {
                    hideWidget();
                    updateStatus('Widget auto-hidden on mobile');
                }, 5000);
            }
            
            updateStatus('Widget loaded successfully');
        }
        
        // Setup widget functionality
        function setupWidgetFunctionality() {
            checkMobile();
            
            // Chat button click handler
            chatToggleButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleWidget();
            });
            
            // Setup event listeners
            setupEventListeners();
            
            // Monitor widget interactions
            setTimeout(() => {
                monitorWidgetInteractions();
            }, 2000);
        }
        
        // Show widget
        function showWidget() {
            if (widgetContainer && elevenLabsWidget) {
                widgetContainer.style.display = 'block';
                chatToggleButton.style.display = 'none';
                chatToggleButton.classList.remove('pulse');
                isWidgetHidden = false;
                clearTimeout(hideTimer);
                
                sendStateToParent('open');
                updateStatus(`Widget shown${isMobile ? ' (mobile)' : ' (desktop)'}`);
                
                // Auto-hide on mobile after 30 seconds if no interaction
                if (checkMobile()) {
                    resetAutoHideTimer();
                }
            }
        }
        
        // Hide widget
        function hideWidget() {
            if (widgetContainer) {
                widgetContainer.style.display = 'none';
                chatToggleButton.style.display = 'flex';
                chatToggleButton.classList.add('pulse');
                isWidgetHidden = true;
                clearTimeout(hideTimer);
                
                sendStateToParent('closed');
                updateStatus(`Widget hidden${isMobile ? ' (mobile auto-hide)' : ''}`);
            }
        }
        
        // Toggle widget visibility
        function toggleWidget() {
            if (isWidgetHidden) {
                showWidget();
            } else {
                hideWidget();
            }
        }
        
        // Reset auto-hide timer for mobile
        function resetAutoHideTimer() {
            if (!checkMobile()) return;
            
            clearTimeout(hideTimer);
            hideTimer = setTimeout(() => {
                if (!isWidgetHidden) {
                    hideWidget();
                }
            }, 30000); // 30 seconds
        }
        
        // Monitor widget interactions to reset auto-hide timer
        function monitorWidgetInteractions() {
            if (!elevenLabsWidget) return;
            
            // Monitor clicks on the widget
            elevenLabsWidget.addEventListener('click', resetAutoHideTimer);
            
            // Monitor mouse movements over widget (for mobile touch)
            elevenLabsWidget.addEventListener('touchstart', resetAutoHideTimer);
            elevenLabsWidget.addEventListener('mouseenter', resetAutoHideTimer);
            
            // Monitor for any activity in shadow DOM if accessible
            try {
                if (elevenLabsWidget.shadowRoot) {
                    elevenLabsWidget.shadowRoot.addEventListener('click', resetAutoHideTimer);
                    elevenLabsWidget.shadowRoot.addEventListener('touchstart', resetAutoHideTimer);
                }
            } catch (e) {
                // Ignore shadow DOM access errors
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Handle window resize
            window.addEventListener('resize', function() {
                const wasMobile = isMobile;
                checkMobile();
                
                // If device changed from mobile to desktop or vice versa
                if (wasMobile !== isMobile) {
                    if (isMobile && !isWidgetHidden) {
                        resetAutoHideTimer();
                    } else if (!isMobile) {
                        clearTimeout(hideTimer);
                    }
                    updateStatus(`Device changed to ${isMobile ? 'mobile' : 'desktop'}`);
                }
            });
            
            // Handle visibility change (user switches tabs)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden && checkMobile() && !isWidgetHidden) {
                    hideWidget();
                }
            });
            
            // Handle escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !isWidgetHidden) {
                    hideWidget();
                }
            });
            
            // Handle clicks outside widget on mobile
            document.addEventListener('click', function(e) {
                if (checkMobile() && !isWidgetHidden && 
                    !widgetContainer.contains(e.target) && 
                    !chatToggleButton.contains(e.target)) {
                    hideWidget();
                }
            });
        }

        function hideBranding() {
            // Hide text-based branding in main document
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                if (el.textContent && (
                    el.textContent.toLowerCase().includes('powered by elevenlabs') ||
                    el.textContent.toLowerCase().includes('elevenlabs') ||
                    el.textContent.toLowerCase().includes('conversational ai') ||
                    el.textContent.toLowerCase().includes('powered by')
                )) {
                    if (el.textContent.trim().length < 100 && !el.querySelector('elevenlabs-convai')) {
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                        el.style.height = '0';
                        el.style.width = '0';
                        el.style.overflow = 'hidden';
                    }
                }
            });

            // Hide branding in shadow DOM
            if (elevenLabsWidget && elevenLabsWidget.shadowRoot) {
                try {
                    const shadowElements = elevenLabsWidget.shadowRoot.querySelectorAll('*');
                    shadowElements.forEach(el => {
                        if (el.textContent && (
                            el.textContent.toLowerCase().includes('powered by') ||
                            el.textContent.toLowerCase().includes('elevenlabs')
                        )) {
                            el.style.display = 'none';
                        }
                    });
                } catch (e) {
                    // Ignore shadow DOM access errors
                }
            }
        }

        // Monitor for dynamic content
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    setTimeout(hideBranding, 100);
                }
            });
        });

        // Wait for ElevenLabs script to load, then initialize
        let checkCount = 0;
        const checkInterval = setInterval(() => {
            if (window.customElements && window.customElements.get('elevenlabs-convai')) {
                clearInterval(checkInterval);
                initializeWidget();
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            } else if (checkCount++ > 50) { // 5 second timeout
                clearInterval(checkInterval);
                showError('Failed to load ElevenLabs widget. Please refresh the page.');
            }
        }, 100);

        // Initial state notification
        setTimeout(() => {
            sendStateToParent('loading');
            updateStatus('Loading ElevenLabs script...');
        }, 500);
        
        // Expose API for parent window
        window.aiWidgetV2 = {
            show: showWidget,
            hide: hideWidget,
            toggle: toggleWidget,
            isHidden: () => isWidgetHidden,
            isMobile: () => isMobile
        };
    </script>
</body>
</html>
